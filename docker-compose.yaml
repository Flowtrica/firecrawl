version: '3.8'

services:
  redis:
    image: 'redis:7-alpine'
    restart: unless-stopped
    command: redis-server --bind 0.0.0.0
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
        compress: "true"

  playwright-service:
    build: apps/playwright-service-ts
    shm_size: 2gb
    cap_add:
      - SYS_ADMIN
    environment:
      PORT: 3000
      BLOCK_MEDIA: 'true'
      MAX_CONCURRENT_PAGES: ${CRAWL_CONCURRENT_REQUESTS:-10}
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        compress: "true"
    tmpfs:
      - /tmp/.cache:noexec,nosuid,size=1g

  searxng:
    image: searxng/searxng
    ports:
      - "8087:8080"
    volumes:
      - ./searxng/settings.yml:/etc/searxng/settings.yml:ro
    environment:
      - SEARXNG_BASE_URL=http://localhost:8080
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        compress: "true"

  postgres:
    image: postgres:15
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  api:
    build: apps/api
    environment:
      PORT: ${INTERNAL_PORT:-3222}
      INTERNAL_PORT: ${INTERNAL_PORT:-3222}
      HOST: "0.0.0.0"
      REDIS_URL: ${REDIS_URL:-redis://redis:6379}
      REDIS_RATE_LIMIT_URL: ${REDIS_URL:-redis://redis:6379}
      PLAYWRIGHT_MICROSERVICE_URL: ${PLAYWRIGHT_MICROSERVICE_URL:-http://playwright-service:3000/scrape}
      NUM_WORKERS_PER_QUEUE: ${NUM_WORKERS_PER_QUEUE:-8}
      CRAWL_CONCURRENT_REQUESTS: ${CRAWL_CONCURRENT_REQUESTS:-10}
      BROWSER_POOL_SIZE: ${BROWSER_POOL_SIZE:-5}

      # SearXNG integration
      SEARXNG_ENDPOINT: http://searxng:8080
    depends_on:
      redis:
        condition: service_started
      playwright-service:
        condition: service_started
      searxng:
        condition: service_started
    ports:
      - "${PORT:-3222}:${INTERNAL_PORT:-3222}"
    command: node dist/src/harness.js --start-docker
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        compress: "true"

    # Traefik labels for subdomain + APIâ€‘key header
    labels:
      - "traefik.http.routers.firecrawl.rule=Host(`${FIRECRAWL_HOST}`)"
      - "traefik.http.routers.firecrawl.entrypoints=websecure"
      - "traefik.http.routers.firecrawl.tls=true"
      - "traefik.http.middlewares.firecrawl-auth.headers.customrequestheaders.X-API-Key=${FIRECRAWL_API_KEY}"
      - "traefik.http.routers.firecrawl.middlewares=firecrawl-auth"

volumes:
  postgres_data:
